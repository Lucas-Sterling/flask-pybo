{% extends 'base.html' %}
{% block content %}
<div class="container my-3">
  <div class="row justify-content-between my-3">
    <div class="col-2">
        <select class="form-control so">
            <option value="recent" {% if so=='recent' %}selected{% endif %}>최신순</option>
            <option value="recommend" {% if so=='recommend' %}selected{% endif %}>추천순</option>
            <option value="popular" {% if so=='popular' %}selected{% endif %}>인기순</option>
        </select>
    </div>

    <!-- 검색 폼 시작 -->
    <form id="searchForm" method="get" action="{{ url_for('question._list') }}" class="input-group col">
        <input name="kw" type="text" class="form-control" value="{{ kw or '' }}" placeholder="검색어를 입력하세요">
        <!-- 검색 시 무조건 1페이지부터 -->
        <input type="hidden" id="page" name="page" value="1">
        <input type="hidden" id="so" name="so" value="{{ so }}">
        <button class="btn btn-outline-secondary" type="submit">찾기</button>
    </form>
    <!-- 검색 폼 끝 -->
  </div>

  <table class="table">
    <thead class="table-dark">
      <tr class="text-center">
        <th>번호</th>
        <th>추천</th>
        <th style="width:50%">제목</th>
        <th>글쓴이</th>
        <th>작성일시</th>
      </tr>
    </thead>
    <tbody>
    {% if question_list and question_list.items %}
      {% for question in question_list.items %}
      <tr class="text-center">
        <td>{{ question_list.total - ((question_list.page-1) * question_list.per_page) - loop.index0 }}</td>
        <td>
          {% if question.voter|length > 0 %}
          <span class="badge bg-warning text-dark px-2 py-1">{{ question.voter|length }}</span>
          {% endif %}
        </td>
        <td class="text-start">
          <a href="{{ url_for('question.detail', question_id=question.id) }}">{{ question.subject }}</a>
          {% if question.answer_set|length > 0 %}
          <span class="text-danger small ms-2">{{ question.answer_set|length }}</span>
          {% endif %}
        </td>
        <td>{{ question.user.username }}</td>
        <td>{{ question.create_date|datetime }}</td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td class="text-center" colspan="5">질문이 없습니다.</td>
      </tr>
    {% endif %}
    </tbody>
  </table>

  <!-- 페이징 -->
  <ul class="pagination justify-content-center">
    {% if question_list.has_prev %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('question._list', page=question_list.prev_num, kw=kw, so=so) }}">이전</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">이전</span></li>
    {% endif %}

    {% for page_num in question_list.iter_pages() %}
      {% if page_num %}
        {% if page_num != question_list.page %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('question._list', page=page_num, kw=kw, so=so) }}">{{ page_num }}</a>
          </li>
        {% else %}
          <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
        {% endif %}
      {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
    {% endfor %}

    {% if question_list.has_next %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('question._list', page=question_list.next_num, kw=kw, so=so) }}">다음</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">다음</span></li>
    {% endif %}
  </ul>

  <a href="{{ url_for('question.create') }}" class="btn btn-primary">질문 등록하기</a>
</div>

{% endblock %}  {# ← content 블록 닫기! #}

{% block script %}
<script type="text/javascript">
$(document).ready(function(){
    $(".so").on('change', function(){
        $("#so").val($(this).val());
        $("#page").val(1);
        $("#searchForm").submit();
    });
});
</script>
{% endblock %}